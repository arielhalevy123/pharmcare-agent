<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmaCare Agent - Pharmacy Assistant</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .chat-container {
      width: 100%;
      max-width: 900px;
      height: 90vh;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .chat-header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .chat-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .user-selector {
      padding: 15px 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-selector label {
      font-weight: 500;
      color: #333;
    }

    .user-selector select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #fafafa;
    }

    .message {
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      text-align: right;
    }

    .message.assistant {
      text-align: left;
    }

    .message-bubble {
      display: inline-block;
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      line-height: 1.5;
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message.assistant .message-bubble {
      background: white;
      color: #333;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tool-call {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      font-size: 13px;
    }

    .tool-call-header {
      font-weight: 600;
      color: #856404;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tool-call-name {
      background: #ffc107;
      color: #333;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .tool-call-args {
      background: white;
      padding: 8px;
      border-radius: 6px;
      margin-top: 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #666;
      overflow-x: auto;
    }

    .tool-result {
      background: #d1ecf1;
      border: 1px solid #0c5460;
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      font-size: 13px;
    }

    .tool-result-header {
      font-weight: 600;
      color: #0c5460;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tool-result-content {
      background: white;
      padding: 8px;
      border-radius: 6px;
      margin-top: 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #666;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
    }

    .timestamp {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .input-area {
      padding: 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
    }

    .input-area input:focus {
      border-color: #667eea;
    }

    .input-area button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .input-area button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .input-area button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .typing-indicator {
      display: inline-block;
      padding: 12px 16px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 18px;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #667eea;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-10px);
      }
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 16px;
      border-radius: 18px;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>ðŸ’Š PharmaCare Agent</h1>
      <p>Your AI Pharmacy Assistant - Bilingual Support (English & Hebrew)</p>
    </div>
    
    <div class="user-selector">
      <label for="userId">User ID:</label>
      <select id="userId">
        <option value="1">1 - Alice Johnson (Has Prescriptions)</option>
        <option value="2">2 - Bob Smith</option>
        <option value="3">3 - Carol White (Has Prescriptions)</option>
        <option value="4">4 - David Brown</option>
        <option value="5">5 - Eve Davis (Has Prescriptions)</option>
        <option value="6">6 - Frank Miller</option>
        <option value="7">7 - Grace Wilson (Has Prescriptions)</option>
        <option value="8">8 - Henry Moore</option>
        <option value="9">9 - Iris Taylor (Has Prescriptions)</option>
        <option value="10">10 - Jack Anderson</option>
      </select>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Ask about medications, stock, or prescriptions..." />
      <button id="sendButton">Send</button>
    </div>
  </div>

  <script>
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const userIdSelect = document.getElementById('userId');

    let currentEventSource = null;
    let currentMessageDiv = null;
    let currentToolCallDiv = null;

    function addMessage(content, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = content;
      
      messageDiv.appendChild(bubble);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      return bubble;
    }

    function addToolCall(toolName, args) {
      const toolDiv = document.createElement('div');
      toolDiv.className = 'tool-call';
      toolDiv.setAttribute('data-tool-name', toolName);
      
      const header = document.createElement('div');
      header.className = 'tool-call-header';
      header.innerHTML = `
        <span>ðŸ”§ Tool Call:</span>
        <span class="tool-call-name">${toolName}</span>
        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
      `;
      
      const argsDiv = document.createElement('div');
      argsDiv.className = 'tool-call-args';
      if (typeof args === 'object' && args !== null) {
        argsDiv.textContent = JSON.stringify(args, null, 2);
      } else {
        argsDiv.textContent = String(args);
      }
      
      toolDiv.appendChild(header);
      toolDiv.appendChild(argsDiv);
      
      if (currentMessageDiv) {
        currentMessageDiv.appendChild(toolDiv);
      } else {
        messagesContainer.appendChild(toolDiv);
      }
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return toolDiv;
    }

    function addToolResult(toolName, result) {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'tool-result';
      
      const header = document.createElement('div');
      header.className = 'tool-result-header';
      header.innerHTML = `
        <span>âœ… Tool Result:</span>
        <span class="tool-call-name">${toolName}</span>
        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
      `;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'tool-result-content';
      contentDiv.textContent = JSON.stringify(result, null, 2);
      
      resultDiv.appendChild(header);
      resultDiv.appendChild(contentDiv);
      
      if (currentMessageDiv) {
        currentMessageDiv.appendChild(resultDiv);
      } else {
        messagesContainer.appendChild(resultDiv);
      }
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function sendMessage() {
      const message = messageInput.value.trim();
      const userId = parseInt(userIdSelect.value);

      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      messageInput.value = '';
      sendButton.disabled = true;

      // Create assistant message container
      currentMessageDiv = document.createElement('div');
      currentMessageDiv.className = 'message assistant';
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      currentMessageDiv.appendChild(bubble);
      messagesContainer.appendChild(currentMessageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Close previous event source if exists
      if (currentEventSource) {
        currentEventSource.close();
      }

      // Create new EventSource for streaming
      const eventSource = new EventSource(`/chat?message=${encodeURIComponent(message)}&userId=${userId}`);
      currentEventSource = eventSource;

      let accumulatedText = '';

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);

          if (data.type === 'text') {
            accumulatedText += data.data;
            bubble.textContent = accumulatedText;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          } else if (data.type === 'tool_call') {
            addToolCall(data.data.name, JSON.parse(data.data.arguments || '{}'));
          } else if (data.type === 'tool_result') {
            addToolResult(data.data.name, data.data.result);
          } else if (data.type === 'done') {
            eventSource.close();
            sendButton.disabled = false;
            currentMessageDiv = null;
            currentEventSource = null;
          } else if (data.type === 'error') {
            bubble.className = 'error';
            bubble.textContent = `Error: ${data.error}`;
            eventSource.close();
            sendButton.disabled = false;
            currentMessageDiv = null;
            currentEventSource = null;
          }
        } catch (e) {
          console.error('Error parsing event data:', e);
        }
      };

      eventSource.onerror = (error) => {
        console.error('EventSource error:', error);
        bubble.className = 'error';
        bubble.textContent = 'Connection error. Please try again.';
        eventSource.close();
        sendButton.disabled = false;
        currentMessageDiv = null;
        currentEventSource = null;
      };
    }

    // Use POST instead of GET for EventSource
    // Since EventSource only supports GET, we'll use fetch with streaming
    function sendMessageWithFetch() {
      const message = messageInput.value.trim();
      const userId = parseInt(userIdSelect.value);

      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      messageInput.value = '';
      sendButton.disabled = true;

      // Create assistant message container
      currentMessageDiv = document.createElement('div');
      currentMessageDiv.className = 'message assistant';
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      currentMessageDiv.appendChild(bubble);
      messagesContainer.appendChild(currentMessageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Use fetch with streaming
      fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message, userId }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let accumulatedText = '';

          function readChunk() {
            return reader.read().then(({ done, value }) => {
              if (done) {
                sendButton.disabled = false;
                currentMessageDiv = null;
                return;
              }

              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  try {
                    const data = JSON.parse(line.slice(6));

                    if (data.type === 'text') {
                      accumulatedText += data.data;
                      bubble.textContent = accumulatedText;
                      messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    } else if (data.type === 'tool_call') {
                      // Update existing tool call or create new one
                      const toolName = data.data.name;
                      const existingToolCall = currentMessageDiv?.querySelector(`.tool-call[data-tool-name="${toolName}"]`);
                      
                      if (existingToolCall) {
                        // Update existing tool call
                        const argsDiv = existingToolCall.querySelector('.tool-call-args');
                        if (argsDiv) {
                          let args = {};
                          try {
                            args = JSON.parse(data.data.arguments || '{}');
                            argsDiv.textContent = JSON.stringify(args, null, 2);
                          } catch (e) {
                            // Partial JSON - show raw
                            argsDiv.textContent = data.data.arguments || '{}';
                          }
                        }
                      } else {
                        // Create new tool call
                        let args = {};
                        try {
                          args = JSON.parse(data.data.arguments || '{}');
                        } catch (e) {
                          args = { raw: data.data.arguments || '{}' };
                        }
                        const toolDiv = addToolCall(toolName, args);
                        if (toolDiv) {
                          toolDiv.setAttribute('data-tool-name', toolName);
                        }
                      }
                    } else if (data.type === 'tool_result') {
                      addToolResult(data.data.name, data.data.result);
                    } else if (data.type === 'done') {
                      sendButton.disabled = false;
                      currentMessageDiv = null;
                      return;
                    } else if (data.type === 'error') {
                      bubble.className = 'error';
                      bubble.textContent = `Error: ${data.error}`;
                      sendButton.disabled = false;
                      currentMessageDiv = null;
                      return;
                    }
                  } catch (e) {
                    console.error('Error parsing SSE data:', e, line);
                  }
                }
              }

              return readChunk();
            });
          }

          return readChunk();
        })
        .catch((error) => {
          console.error('Fetch error:', error);
          bubble.className = 'error';
          bubble.textContent = 'Connection error. Please try again.';
          sendButton.disabled = false;
          currentMessageDiv = null;
        });
    }

    sendButton.addEventListener('click', sendMessageWithFetch);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendButton.disabled) {
        sendMessageWithFetch();
      }
    });
  </script>
</body>
</html>

